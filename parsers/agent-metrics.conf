// Parser for Scalyr Agent metrics logs.

{
  // Sample input text:
  //
  // 2014-05-27 23:20:39.587Z [linux_system_metrics()] proc.stat.cpu 56175301 type="system"

  // Tag these entries as source=tsdb, to match events generated by the old (Java-based) Scalyr agent.
  attributes: {
    source: "tsdb"
  },

  patterns: {
    // Special case to also make sure we match last key=value pair where a value is non-quoted
    // (e.g. an integer). If we don't handle that here, last key=value pair will have \n appended
    // to the parsed value which will is not really desired since that would make any integer a
    // string - e.g. "0\n".
    // Here is an example of such line:
    //
    // 2021-01-10 15:38:13.394Z [shell_monitor(mdadm_degraded)] output "" command="mdadm -D /dev/md0 | grep -i degraded" length=0\n
    //
    // Keep in mind that this issue doesn't affect quoted values.
    nonQuoted: "[^\"\n ]+"
  },

  formats: [
    // Parse any key=value pairs, with or without quotes.
    {
      format: ".* $_=identifier$=\"$_$\"", repeat: true
    },
    {
      format: ".* $_=identifier$=$_=nonQuoted$", repeat: true
    },
    // Parse the basic line format. This variant matches lines that have at least one key=value pair --
    // note the trailing space character in the format string, which won't match if there are no key=value
    // pairs. We specify halt: true, to avoid falling through to the next format when this format matches.
    {
      format: "$timestamp$ \\[$monitor$\\($instance$\\)\\] $metric$ $value$ ",
      halt: true
    },
    // This variant parses the basic line format when there are no key=value pairs. We don't want to use
    // this variant when there are key=value pairs, because it would include them as part of the "value" field.
    {
      format: "$timestamp$ \\[$monitor$\\($instance$\\)\\] $metric$ $value$",
      halt: true
    }
  ]
}
